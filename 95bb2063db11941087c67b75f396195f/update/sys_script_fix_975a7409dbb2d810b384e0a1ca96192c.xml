<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_fix">
    <sys_script_fix action="INSERT_OR_UPDATE">
        <before>false</before>
        <description/>
        <name>Set inStock for Hardware</name>
        <record_for_rollback>false</record_for_rollback>
        <script><![CDATA[var grModel = new GlideRecord('cmdb_hardware_product_model');
grModel.query();

while (grModel.next()) {

	var ga = new GlideAggregate('alm_asset');

	ga.addQuery('model', grModel.getUniqueValue());
	ga.addQuery('install_status', 6);
	ga.addQuery('substatus', 'available');
	ga.addAggregate('COUNT');
	ga.query();

	var inStock;

	while (ga.next()) {
		inStock = ga.getAggregate('COUNT');
	}

	grModel.setValue('x_hak_price_calc_in_stock', inStock);

	var grAsset = new GlideRecord('alm_asset');
	grAsset.addQuery('model', grModel.getUniqueValue());
	grAsset.addQuery('install_status', 6);
	grAsset.addQuery('substatus', 'available');
	grAsset.query(); // filterar på produkten, asseten ska vara state: In Stock och substatus: Available

	var totalCost = 0;
	while (grAsset.next()){ 
		totalCost += parseFloat(grAsset.cost); // går igenom alla records och summerar alla värden från fältet cost.
	}

	if (inStock != 0) {

		var averageCost = totalCost / inStock; // räknar ut genomsnitts-inköpskostnaden för modellen, baserat på de som är i lager.
		averageCost = Math.round(averageCost, 0); // avrundar värdet

		grModel.setValue('x_hak_price_calc_average_cost', averageCost); // sätter genomsnitts-inköpspriset till fältet x_hak_price_calc_average_cost
	}

	grModel.update();
}]]></script>
        <sys_class_name>sys_script_fix</sys_class_name>
        <sys_created_by>jonatan.horvath@halmstad.se</sys_created_by>
        <sys_created_on>2020-08-21 07:06:16</sys_created_on>
        <sys_id>975a7409dbb2d810b384e0a1ca96192c</sys_id>
        <sys_mod_count>5</sys_mod_count>
        <sys_name>Set inStock for Hardware</sys_name>
        <sys_package display_value="Price Calculation" source="x_hak_price_calc">95bb2063db11941087c67b75f396195f</sys_package>
        <sys_policy/>
        <sys_scope display_value="Price Calculation">95bb2063db11941087c67b75f396195f</sys_scope>
        <sys_update_name>sys_script_fix_975a7409dbb2d810b384e0a1ca96192c</sys_update_name>
        <sys_updated_by>jonatan.horvath@halmstad.se</sys_updated_by>
        <sys_updated_on>2020-08-21 11:43:10</sys_updated_on>
        <unloadable>false</unloadable>
    </sys_script_fix>
</record_update>
